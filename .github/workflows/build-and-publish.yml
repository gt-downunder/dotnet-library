name: Build Project and Publish NuGet Package

on:
    workflow_dispatch:
    push:
        branches:
            - main

permissions:
  contents: read

env:
  DOTNET_SDK_VERSION: 10.0.x
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  build:
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.set_version.outputs.VERSION }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Generate dynamic version number
      id: set_version
      run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

    - name: Restore dependencies
      run: dotnet restore Grondo.sln

    - name: Build
      run: dotnet build Grondo.sln --no-restore -c Release

    - name: Run tests with coverage
      run: >-
        dotnet test tests/Grondo.Tests.csproj --no-restore -c Release
        --collect:"XPlat Code Coverage"
        --results-directory ./coverage

    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool

    - name: Generate coverage report
      run: >-
        reportgenerator
        -reports:./coverage/**/coverage.cobertura.xml
        -targetdir:./coverage/report
        -reporttypes:MarkdownSummaryGithub

    - name: Write coverage to job summary
      run: cat ./coverage/report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

    - name: Pack
      run: dotnet pack src/Grondo.csproj --no-build -c Release -p:PackageVersion=${{ env.VERSION }} -o ./nupkgs/

    - name: Upload NuGet packages
      uses: actions/upload-artifact@v6
      with:
        name: nupkgs-${{ env.VERSION }}
        path: ./nupkgs/

  publish:
    needs: build
    runs-on: ubuntu-24.04

    steps:
    - name: Download NuGet packages
      uses: actions/download-artifact@v7
      with:
        name: nupkgs-${{ needs.build.outputs.VERSION }}
        path: ./nupkgs/

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_SDK_VERSION }}

    - name: Push to NuGet
      run: dotnet nuget push ./nupkgs/*.nupkg --api-key ${{ secrets.nuget_api_key }} --source https://api.nuget.org/v3/index.json --skip-duplicate
